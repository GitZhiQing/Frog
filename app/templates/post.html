{% extends 'base.html' %}
{% block subtitle %}{{ title }}{% endblock %}
{% block links %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/remarkable/1.7.4/remarkable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
  />
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/markdown.css') }}"
  />
{% endblock %}

{% block content %}
  <div id="md-container" class="markdown-body"></div>
  <div class="metadata">
    <div class="metadata-left">
      {% if category %}
        <span class="metadata-item">
          分类:
          <a href="{{ url_for('nav.archive', category=category) }}"
            >{{ category }}</a
          >
        </span>
      {% endif %}
      {% if tags %}
        <span class="metadata-item">
          标签:
          {% for tag in tags %}
            <span class="tag">
              <a href="{{ url_for('nav.archive', tag=tag) }}"
                >{{ tag }}</a
              ></span
            >
          {% endfor %}
        </span>
      {% endif %}
    </div>
    {% if date %}
      <div class="metadata-right">
        <span class="metadata-date">写作于 {{ date }}</span>
      </div>
    {% endif %}
  </div>

  {% if form %}
    <style>
      a {
        border: none;
      }
      /* 基础样式 */
      .comment-form {
        max-width: 100%;
        margin: 2rem auto;
        padding: 1.5rem;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        color: var(--color-text);
      }
      .form-section {
        margin-bottom: 1.5rem;
      }
      .form-title {
        margin: 0 0 1.5rem;
        font-size: 1.5rem;
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 0.5rem;
      }

      /* 表单组 */
      .form-group {
        margin-bottom: 1rem;
      }
      .form-label {
        display: block;
        margin-bottom: 0.2rem;
        font-weight: 400;
        font-size: 0.875rem;
        color: var(--color-text);
      }

      /* 输入字段 */
      .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        font-size: 1rem;
        outline: none;
        background-color: var(--color-bg-body);
        color: var(--color-text);
      }
      .form-input:focus {
        border: 1px solid var(--color-primary);
        outline: none;
      }
      .textarea {
        resize: vertical;
        min-height: 100px;
      }

      /* 错误状态 */
      .error-field {
        border-color: #e74c3c !important;
      }
      .error-message {
        color: #e74c3c;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        display: none;
      }
      .error-field + .error-message {
        display: block;
      }

      /* 提交按钮 */
      .submit-group {
        margin-top: 1.5rem;
      }
      .submit-btn {
        width: 100%;
        padding: 0.5rem;
        background: var(--color-primary);
        color: var(--color-text);
        border: none;
        border-radius: 4px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      .submit-btn:hover {
        background: var(--color-secondary);
      }
      .hidden-field {
        display: none;
      }
      .comments h3 {
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
      }
      .comment {
        border-radius: 4px;
        margin: 1rem 0;
        padding: 0.5rem 1rem;
        border: 1px solid var(--color-border);
      }
      .comment .quote {
        background: var(--color-bg-body);
        padding: 0.5rem;
        margin: 0.5rem 0;
        border-left: 3px solid var(--color-border);
      }
      .comment .quote .reply-to {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
      }
      .comment .quote .reply-to a {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
      }
      .comment .quote .reply-to a:hover {
        color: var(--color-primary);
      }
      .comment .meta {
        font-size: 0.9em;
        color: var(--color-text-secondary);
      }
      .comment .meta a {
        color: var(--color-text);
      }
      .comment .meta .name {
        font-weight: bold;
        font-size: 1rem;
        color: var(--color-primary);
      }
      .comment .meta a:hover {
        color: var(--color-primary);
      }
    </style>
    {# 评论表单部分 #}
    <form method="POST" class="comment-form">
      {{ form.hidden_tag() }}
      {{ form.parent_id(class="hidden-field") }}

      <div class="form-section">
        <h3 class="form-title">发表评论</h3>
        <!-- 名称字段 -->
        <div class="form-group">
          {{ form.name.label(class="form-label") }}
          {{
            form.name(class="form-input" + (" error-field" if form.name.errors else ""),
            placeholder="请输入您的姓名")
          }}
          {% for error in form.name.errors %}
            <div class="error-message">{{ error }}</div>
          {% endfor %}
        </div>

        <!-- 邮箱字段 -->
        <div class="form-group">
          {{ form.email.label(class="form-label") }}
          {{
            form.email(class="form-input" + (" error-field" if form.email.errors else ""),
            placeholder="example@domain.com")
          }}
          {% for error in form.email.errors %}
            <div class="error-message">{{ error }}</div>
          {% endfor %}
        </div>

        <!-- 链接字段 -->
        <div class="form-group">
          {{ form.link.label(class="form-label") }}
          <div class="input-group">
            {{
              form.link(class="form-input" + (" error-field" if form.link.errors else ""),
              placeholder="https://")
            }}
          </div>
          {% for error in form.link.errors %}
            <div class="error-message">{{ error }}</div>
          {% endfor %}
        </div>

        <!-- 内容字段 -->
        <div class="form-group">
          {{ form.content.label(class="form-label") }}
          {{
            form.content(class="form-input textarea" + (" error-field" if form.content.errors else ""),
            rows="5", placeholder="请输入您的评论内容...")
          }}
          {% for error in form.content.errors %}
            <div class="error-message">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="submit-group">
          <button type="submit" class="submit-btn">提交评论</button>
        </div>
      </div>
    </form>
    {# 评论列表部分 #}
    <div class="comments">
      <h3 class="comment-title">
        评论列表 | 共 {{ comments | length }} 条评论
      </h3>
      {% for comment in comments %}
        <div class="comment" id="comment-{{ comment.cid }}">
          <div class="meta">
            <a class="name" href="{{ comment.link }}" target="_blank"
              >{{ comment.name }}</a
            >&nbsp;于&nbsp;<time>{{ comment.created_at | ts2date }}</time>&nbsp;发布&nbsp;|&nbsp;<a
              href="#comment-form"
              onclick="setReply({{ comment.cid }}, '{{ comment.name }}')"
              >回复</a
            >
          </div>
          <div class="content">{{ comment.content }}</div>

          {# 显示被回复的原始评论 #}
          {% if comment.parent %}
            <div class="quote">
              <span class="reply-to">
                回复给
                <a href="#comment-{{ comment.parent.cid }}"
                  >@{{ comment.parent.name }}</a
                >:
              </span>
              <blockquote>{{ comment.parent.content|truncate(50) }}</blockquote>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
{% block scripts %}
  <script>
    // DOM 工具类
    const DOM = {
      get: (selector) => document.querySelector(selector),
      create: (tag, className, text) => {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (text) el.textContent = text;
        return el;
      },
    };

    // Markdown 处理器
    class MarkdownProcessor {
      constructor() {
        this.md = new Remarkable("full", {
          html: true,
          breaks: true,
          langPrefix: "language-",
          linkify: true,
          linkTarget: "_blank",
          highlight: this.highlightCode,
        });
        this.output = DOM.get("#md-container");
      }

      highlightCode(str, lang) {
        return hljs.getLanguage(lang)
          ? hljs.highlight(str, { language: lang }).value
          : hljs.highlightAuto(str).value;
      }

      async render(content) {
        this.output.innerHTML = this.md.render(content);
        hljs.highlightAll();
        this.processCodeBlocks();
        this.renderMath();
      }

      processCodeBlocks() {
        document.querySelectorAll("pre code").forEach((codeBlock) => {
          const lang = this.getCodeLanguage(codeBlock);
          const wrapper = codeBlock.closest("pre");
          wrapper.classList.add("code-wrapper");
          wrapper.append(
            this.createLanguageTag(lang),
            this.createCopyButton(codeBlock),
          );
        });
      }

      getCodeLanguage(codeBlock) {
        const className = codeBlock.className.split(" ")[0];
        return className.includes("language-")
          ? className.replace("language-", "")
          : "code";
      }

      createLanguageTag(lang) {
        return DOM.create("span", "code-language", lang);
      }

      createCopyButton(codeBlock) {
        const button = DOM.create("button", "copy-btn", "复制");
        button.onclick = () => this.handleCopy(codeBlock, button);
        return button;
      }

      handleCopy(codeBlock, button) {
        navigator.clipboard.writeText(codeBlock.textContent).then(() => {
          button.textContent = "已复制";
          setTimeout(() => (button.textContent = "复制"), 2000);
        });
      }

      renderMath() {
        renderMathInElement(this.output, {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false },
          ],
          ignoredTags: [
            "script",
            "noscript",
            "style",
            "textarea",
            "pre",
            "code",
          ],
        });
      }
    }

    // 定义应用
    class App {
      static async init() {
        const processor = new MarkdownProcessor();
        try {
          const response = await fetch(
            "{{ url_for('posts.get_post', title=title) }}",
          );
          if (!response.ok) throw new Error(`加载失败: ${response.status}`);
          const content = await response.text();
          processor.render(content);
        } catch (error) {
          console.error("初始化失败:", error);
          processor.render("# 内容加载失败\n请检查文件路径或网络连接");
        }
      }
    }

    // 启动应用
    document.addEventListener("DOMContentLoaded", App.init);

    function setReply(parentId, author) {
      document.querySelector("#parent_id").value = parentId;
      document.querySelector("#content").focus();
      document.querySelector("#content").placeholder = `回复 ${author}: `;
    }
  </script>
{% endblock %}
