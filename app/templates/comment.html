<link rel="stylesheet" href="{{ url_for('static', filename='css/comment.css') }}" />
<div class="comments-section">
  <h4>评论</h4>
  <form id="comment-form" method="post">
    <input type="hidden" name="parent_id" value="" />
    <div>
      <label for="author">昵称<span class="required">*</span>:</label>
      <input type="text" id="author" name="author" placeholder="怎么称呼你" required />
    </div>
    <div class="comment-social">
      <div>
        <label for="website">网站:</label>
        <input type="text" id="website" name="website" placeholder="你的站点链接" />
      </div>
      <div>
        <label for="email">邮箱:</label>
        <input type="email" id="email" name="email" placeholder="邮箱不会被公开，仅用于我联系你" />
      </div>
    </div>
    <div>
      <label for="content">评论<span class="required">*</span>:</label>
      <textarea id="content" name="content" required></textarea>
    </div>
    <button type="submit">提交评论</button>
  </form>

  <div class="comments">
    {% for comment in comments %}
      <div class="comment" id="comment-{{ comment.id }}">
        <p class="comment-header">
          <a href="{{ comment.website }}" class="comment-author-url" target="_blank" rel="noopener noreferrer"><strong>{{ comment.author }}</strong></a>
          于 {{ comment.created_at }} 说:
        </p>
        <p class="comment-content">{{ comment.content }}</p>
        <a href="#" class="reply-link" data-comment-id="{{ comment.id }}">回复</a>
        <div class="replies">
          {% for reply in comment.replies %}
            <div class="reply" id="comment-{{ reply.id }}">
              <p class="reply-header">
                <a href="{{ reply.website }}" class="comment-author-url" target="_blank" rel="noopener noreferrer"><strong>{{ reply.author }}</strong></a> 于 {{ reply.created_at }} 说:
              </p>
              <p class="reply-content">{{ reply.content }}</p>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
  document.querySelectorAll('.reply-link').forEach((link) => {
    link.addEventListener('click', function (event) {
      event.preventDefault()
      const commentId = this.getAttribute('data-comment-id')
      const existingForm = this.parentElement.querySelector('.reply-form')
      if (existingForm) {
        existingForm.scrollIntoView({ behavior: 'smooth' })
        return
      }
      const form = document.getElementById('comment-form').cloneNode(true)
      form.classList.add('reply-form')
      form.querySelector('input[name="parent_id"]').value = commentId
      this.parentElement.appendChild(form)
      form.scrollIntoView({ behavior: 'smooth' })
    })
  })
  
  const newCommentId = '{{ new_comment_id }}'
  if (newCommentId) {
    const newCommentElement = document.getElementById(`comment-${newCommentId}`)
    if (newCommentElement) {
      newCommentElement.scrollIntoView({ behavior: 'smooth' })
    }
  }
</script>
